rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Members collection: any authenticated user can read profiles,
    // users can write their own, admins can write any
    match /members/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.token.admin == true
      );
      allow delete: if request.auth != null && request.auth.token.admin == true;
    }

    // Organizations: any authenticated user can read,
    // org owner (uid == orgId) can create/update, admin can write any
    match /organizations/{orgId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == orgId;
      allow update: if request.auth != null && (
        request.auth.uid == orgId ||
        request.auth.token.admin == true
      );
      allow delete: if request.auth != null && request.auth.token.admin == true;
    }

    // Posts: any authenticated user can read, admin can write,
    // org members (owner/admin role) can create/update posts for their org
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
      allow create: if request.auth != null &&
        exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/members/$(request.auth.uid)).data.orgId == request.resource.data.orgId &&
        get(/databases/$(database)/documents/members/$(request.auth.uid)).data.orgRole in ["owner", "admin"];
      allow update: if request.auth != null &&
        exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/members/$(request.auth.uid)).data.orgId == resource.data.orgId &&
        get(/databases/$(database)/documents/members/$(request.auth.uid)).data.orgRole in ["owner", "admin"];
    }

    // Saved items: users can read/write their own saves
    match /saved_items/{itemId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Applications: users can read/create/update their own, admin can read/update all,
    // org members can read/update applications for posts belonging to their org
    match /applications/{appId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.token.admin == true ||
        (exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/members/$(request.auth.uid)).data.orgRole in ["owner", "admin"])
      );
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.token.admin == true ||
        (exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/members/$(request.auth.uid)).data.orgRole in ["owner", "admin"])
      );
    }

    // Notifications: users can read/update/create their own
    match /notifications/{notifId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Conversations: participants can read/create/update
    match /conversations/{convId} {
      allow read: if request.auth != null &&
        request.auth.uid in resource.data.participants;
      allow create: if request.auth != null &&
        request.auth.uid in request.resource.data.participants;
      allow update: if request.auth != null &&
        request.auth.uid in resource.data.participants;
    }

    // Messages: only conversation participants can read,
    // authenticated users can create messages in their conversations
    match /messages/{msgId} {
      allow read: if request.auth != null &&
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants;
      allow create: if request.auth != null &&
        request.resource.data.senderId == request.auth.uid;
    }

    // Member settings: users can read/write their own settings
    match /member_settings/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, update: if request.auth != null && request.auth.uid == userId;
    }

    // Notification preferences: users can read/write their own preferences
    match /notification_preferences/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, update: if request.auth != null && request.auth.uid == userId;
    }

    // Event RSVPs: authenticated users can read (for count queries),
    // users can create/update/delete their own RSVPs
    match /event_rsvps/{rsvpId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Content reports: authenticated users can create (own reporterId),
    // users can read their own reports, admin can read/update all
    match /content_reports/{reportId} {
      allow read: if request.auth != null && (
        resource.data.reporterId == request.auth.uid ||
        request.auth.token.admin == true
      );
      allow create: if request.auth != null &&
        request.resource.data.reporterId == request.auth.uid;
      allow update: if request.auth != null && request.auth.token.admin == true;
    }

    // Mail queue: authenticated users can create (queue emails),
    // only admin can read (view queue and stats)
    match /mail/{mailId} {
      allow read: if request.auth != null && request.auth.token.admin == true;
      allow create: if request.auth != null;
    }

    // Connections (follow system): authenticated users can read all,
    // users can create/delete connections where followerId matches their uid
    match /connections/{connectionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        request.resource.data.followerId == request.auth.uid;
      allow delete: if request.auth != null &&
        resource.data.followerId == request.auth.uid;
    }

    // Subscriptions: org owner can read/create, admin/mod can read/update
    match /subscriptions/{subId} {
      allow read: if request.auth != null && (resource.data.orgId == request.auth.uid || get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin', 'moderator']);
      allow create: if request.auth != null && request.resource.data.orgId == request.auth.uid;
      allow update: if request.auth != null && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }

    // Shop vendors: public read, admin/moderator write
    match /shop_vendors/{vendorId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }

    // Shop listings: public read, admin/moderator write
    match /shop_listings/{listingId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }

    // Training programs: public read, admin/moderator write
    match /training_programs/{programId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }

    // Training enrollments: users can read/create/update their own, admin/moderator can read all
    match /training_enrollments/{enrollmentId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin', 'moderator']);
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Endorsements: public read, authenticated create (own endorserId, can't self-endorse),
    // endorser or target can delete
    match /endorsements/{endorsementId} {
      allow read: if true;
      allow create: if request.auth != null &&
        request.resource.data.endorserId == request.auth.uid &&
        request.resource.data.endorserId != request.resource.data.targetUserId;
      allow delete: if request.auth != null && (
        resource.data.endorserId == request.auth.uid ||
        resource.data.targetUserId == request.auth.uid
      );
    }

    // Livestreams: public read, admin write
    match /livestreams/{docId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin'];
    }

    // Feed sources: admin only
    match /feed_sources/{docId} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin'];
    }

    // Partner showcase: public read, admin write
    match /partner_showcase/{docId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in ['admin'];
    }

    // Mentor profiles: public read, users can create/update their own profile
    match /mentor_profiles/{docId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == docId;
      allow update: if request.auth != null && request.auth.uid == docId;
    }

    // Mentorship requests: mentor and mentee can read their own,
    // mentee can create, mentor can update (accept/decline)
    match /mentorship_requests/{reqId} {
      allow read: if request.auth != null && (resource.data.mentorId == request.auth.uid || resource.data.menteeId == request.auth.uid);
      allow create: if request.auth != null && request.resource.data.menteeId == request.auth.uid;
      allow update: if request.auth != null && resource.data.mentorId == request.auth.uid;
    }

    // Default: deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
